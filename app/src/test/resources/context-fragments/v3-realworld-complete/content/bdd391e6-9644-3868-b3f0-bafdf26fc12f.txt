## Regression test: bmo_spin_exec precision (test_bmo_spin_precision.c)

Summary

- Add a C unit test that calls the BMesh Spin operator backend (`bmo_spin_exec`) directly to detect cumulative floating-point drift.
- The test runs the spin operator on a tiny mesh (single edge or triangle) with large step counts to amplify any drift (e.g. 200 and 800 steps).
- It runs two configurations:
  - Pure rotation (dvec = {0,0,0})
  - Rotation with screw translation (non-zero dvec)
- For each new step produced by the operator, it compares a representative vertex position against the analytical absolute transform computed from the original vertex position (step-0) using the same `space` transform and axis.
- The analytical target uses absolute rotation R(angle * i/steps) and the precisely accumulated screw translation sum_{k=1..i} (R_k * dvec_space), where accumulation is done in double precision, then cast to float for comparison.

Test details / Implementation notes for the Code Agent

- Test file path: `source/blender/bmesh/tests/test_bmo_spin_precision.c` (created above as a placeholder). The Code Agent should implement the test content.

- Setup the minimal BMesh geometry:
  - Create a new BMesh with either a single edge (two verts, one edge) or a triangle (3 verts, 3 edges, 1 face). Using a triangle is slightly more realistic but an edge is fine and simpler.
  - Choose a vertex to validate (e.g., vertex index 0). Make sure to record its original object-space coordinate `P0`.

- Operator initialization and inputs:
  - Initialize a BMOperator for the spin op. In other tests this is usually done via `BMO_op_init(bm, &op, op.flag, "spin")` or `BMO_op_initf` with relevant parameters.
  - Provide input slots as used by `bmo_spin_exec`: at minimum set `cent` (vec3), `axis` (vec3, normalized), `dvec` (vec3), `steps` (int), `angle` (float), `space` (4x4 matrix). Use identity `space` for simplicity to avoid extra coordinate transform complexity. Also set `use_duplicate=true` to exercise the duplicate path, and use_merge as appropriate (test can run without merge or with `use_merge=false` for simpler assertions).
  - For `dvec = 0` case set `dvec` zero; for screw translation case set `dvec` to a small non-zero vector (e.g., {0.01f, 0.02f, 0.003f}) so translations remain small but visible.

- Execution and result inspection:
  - Before invoking `bmo_spin_exec`, iterate BMesh verts and write a `co_orig[]` array containing the original positions of all verts (object space coordinates). Save the original per-vertex index mapping if the operator expects to write indices into `v->no` like the implementation does.
  - After each spin step the operator places new geometry into `geom_last.out` (as the implementation uses). The test should examine the `geom.out` buffer returned by the duplicate/extrude op invoked during each step. For each new BMVert produced at a step `i` (1..steps), retrieve the vertex pointer and read the saved original index (as `v->no` was used by the operator). Use that index to locate `P0` in `co_orig`.

- Analytical transform and comparison (space == identity):
  - Use the same axis and angle as provided to the operator. For step i compute angle_i = angle_total * (i / steps).
  - Compute rotation matrix (or quaternion) for axis-angle(angle_i). Use the Blender math helpers available in tests (or reimplement a small stable axis-angle->mat3 routine if needed). The operator itself uses `axis_angle_normalized_to_mat3`, but tests can compute the same.
  - For screw translation: compute dvec_space = dvec (space is identity). Compute R_k for k = 1..i (angle_k = angle_total * (k / steps)), and accumulate t_accum_double += R_k * dvec_space in double precision. After summation, cast to float to produce final t_space.
  - Analytical target in object space: P_target = cent + R_i * (P0 - cent) + t_space.
  - Retrieve the actual new vertex coordinate `v_new->co` and compare component-wise difference to `P_target`.

- Error tolerances:
  - Use a tight epsilon since the change is meant to fix numerical drift. Suggested tolerances:
    - For dvec = 0 (pure rotation): epsilon = 1e-6
    - For screw translation: epsilon = 1e-5
  - The test should assert the maximum absolute coordinate deviation is <= epsilon for each step and for the selected vertex.

- Step counts & range:
  - Include at least two large step counts: e.g., 200 and 800 (or up to 1000 if runtime is OK in CI). The test can parameterize over these counts. Use a smaller geometry so execution remains fast.

- Test harness & utilities:
  - Reuse existing BMesh test helpers if present in the repo (setup/teardown routines), and follow naming conventions of other tests in `source/blender/bmesh/tests/`.
  - Register the test in the same way other BMesh unit tests are organized (CMake test registration may be requiredâ€”leave to the Code Agent if needed). If the repository uses a custom test harness for C tests, follow the same style as the neighboring tests in the same directory.

- Additional checks (optional):
  - Verify topology (number of vertices/edges) behaves as expected after spin.
  - Check the final merged vertices are near-identical after a full revolution when `use_merge` behavior is enabled.

Rationale / Purpose

- This regression test is intended to fail for implementations that apply incremental rotations/translations cumulatively (which accumulate rounding error) and to pass for the fixed implementation that computes absolute transforms per-step and accumulates screw translation in double precision.

Notes for the Code Agent

- Do not modify `bmo_dupe.cc` here; your role is to add the test file and ensure it exercises `bmo_spin_exec` correctly. Provide clear, maintainable test code that other developers can run.
- If helper functions are absent in the test environment (e.g., axis-angle math helpers), the test may include a local, small, well-tested routine for axis-angle to mat3 or quaternion conversion.

If you need specific helper file locations or examples from other BMesh tests to mirror, ask and I will fetch them.

## Test harness summary (extracted from bmesh_core_test.cc)

- Typical includes used in BMesh tests:
  - "../bmesh_tests.h" or similar test helper headers found relative to the tests directory.
  - "BLI_math_vector.h", "BLI_math_matrix.h" for math helpers if needed.
  - "bmesh.hh" and other BMesh internals for creating and manipulating meshes.

- Test style observed:
  - Uses plain C/C++ test file in the repository's tests tree.
  - Sets up a BMesh instance with helper functions/macros from local test helpers.
  - Allocations and BM API usage follow the patterns: BM_vert_create, BM_edge_create, BM_iter, BMO_op_init/BMO_op_initf, BMO_op_exec/BMO_op_finish, BMO_slot_get, BMO_slot_* helpers.
  - Assertions use plain C assert or BLI_assert depending on test; other tests simply check invariants and return failures via test harness.

- What the Code Agent will need to implement the regression test:
  - A new test file at `source/blender/bmesh/tests/test_bmo_spin_precision.c` (or .cc matching project style). The test must include the same headers as `bmesh_core_test.cc` to access BMesh and BMO APIs and test helpers.
  - Use a minimal mesh (single edge or triangle) created via BM_vert_create/BM_edge_create (and BM_face_create if triangle) to keep runtime low.
  - Initialize and populate a BMOperator for the "spin" op using `BMO_op_init`/`BMO_op_initf`, set required slots: "cent", "axis", "dvec", "steps", "angle", "space", and boolean flags such as "use_duplicate" and "use_merge".
  - Before running the operator, store original vertex positions (co_orig[]) and set / rely on `v->no` being written by the operator (bmo_spin_exec writes indices into v->no), so the test should read the newly created vertices from the returned "geom.out" buffer and use `v_new->no` to index into co_orig.
  - Compute analytical targets using axis-angle rotation helper `axis_angle_normalized_to_mat3` (available in Blender math headers), and accumulate screw translation in double precision for the dvec != 0 case.
  - Use tight epsilons: ~1e-6 for pure rotation, ~1e-5 for screw translation.

- Additional notes for the Code Agent (do not implement here):
  - If math helpers are not directly available in the test compilation unit, include `BLI_math_rotation.h` / `BLI_math_matrix.h` or implement a small axis-angle->mat3 routine locally in the test.
  - Follow the include and test-register conventions used by `bmesh_core_test.cc` so CI/test harness picks up the new test. If the repo uses CMake registrations for tests, the Code Agent should add the new file to the relevant CMakeLists; otherwise, follow the pattern used by `bmesh_core_test.cc`.

This note + the existing `bmo_dupe.cc` implementation and symbol search results provide the Code Agent with the minimal context needed to create `test_bmo_spin_precision.c` that exercises `bmo_spin_exec` and asserts no drift across many steps.